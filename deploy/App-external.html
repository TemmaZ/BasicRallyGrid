<!DOCTYPE html>
<html>
<head>
    <title>BasicRallyGrid</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.myLayout=Ext.create("Ext.container.Container",{layout:{type:"hbox",align:"stretch"}}),this.add(this.myLayout),this._loadDateForChart()},_loadDateForChart:function(){var end=new Date,start=Ext.Date.add(end,Ext.Date.MONTH,-1);this.startDate=Ext.create("Ext.form.field.Date",{fieldLabel:"Start Date:",labelAlign:"right",value:start,maxValue:end,listeners:{select:function(combobox,records){this.startChartDate=records,this.endDate&&this.endDate.setMinValue(records),this._loadData()},scope:this}}),this.myLayout.add(this.startDate),this.endDate=Ext.create("Ext.form.field.Date",{fieldLabel:"End Date:",labelAlign:"right",minValue:start,value:end,maxValue:end,listeners:{select:function(combobox,records){this.endChartDate=records,this.startDate&&this.startDate.setMaxValue(records),this._loadData()},scope:this}}),this.startChartDate=start,this.endChartDate=end,this.myLayout.add(this.endDate),this._loadData()},_loadData:function(){this.chart&&this.remove(this.chart),this.startDate.setDisabled(!0),this.endDate.setDisabled(!0);var filter1=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:">=",value:Ext.Date.format(this.startChartDate,"Y-m-d")}),filter2=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:"<=",value:Ext.Date.format(this.endChartDate,"Y-m-d")}),filter3=Ext.create("Rally.data.wsapi.Filter",{property:"Environment",operator:"=",value:"Production"}),filter4=Ext.create("Rally.data.wsapi.Filter",{property:"c_IssueType",operator:"=",value:"Bug"}),filter=filter1.and(filter2).and(filter3).and(filter4);this.myStore?(this.myStore.setFilter(filter),this.myStore.load()):this.myStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",autoLoad:!0,filters:filter,listeners:{load:function(myStore,myData,success){this._createChart(myStore)},scope:this},limit:1/0}),this.startDate.setDisabled(!1),this.endDate.setDisabled(!1)},_createChart:function(myStore){var bufferArrya=[],days=[],countDay=~~((this.endChartDate-this.startChartDate)/1e3/60/60/24+.5),byMonth,inc=0,bufferDay=this.startChartDate,indexInDaysArray=new Map;if(countDay>=240){for(byMonth=new Map;Ext.Date.format(bufferDay,"M Y")!=Ext.Date.format(this.endChartDate,"M Y");bufferDay=Ext.Date.add(bufferDay,Ext.Date.MONTH,1)){var string=Ext.Date.format(bufferDay,"M Y");byMonth.set(string,days.length),days.push(string),bufferArrya.push(0)}byMonth.set(Ext.Date.format(bufferDay,"M Y"),days.length),days.push(Ext.Date.format(bufferDay,"M Y")),bufferArrya.push(0),indexInDaysArray=new Map(byMonth)}else{if(countDay>31){for(var count,del=31;del>=12;--del){var buf=countDay/del;if(.2>=buf-~~buf){count=del;break}}count||(count=12),inc=~~(countDay/count+.5)}else inc=1;for(;Ext.Date.format(bufferDay,"Ymd")<Ext.Date.format(this.endChartDate,"Ymd");bufferDay=Ext.Date.add(bufferDay,Ext.Date.DAY,inc)){var string=Ext.Date.format(bufferDay,"M d");indexInDaysArray.set(string,days.length),days.push(string),bufferArrya.push(0)}indexInDaysArray.set(Ext.Date.format(this.endChartDate,"M d"),days.length),days.push(Ext.Date.format(this.endChartDate,"M d")),bufferArrya.push(0)}var map=new Map;console.log(myStore.getCount(),days,days.length,inc),this.startChartDate.setHours(0),this.startChartDate.setMilliseconds(0),this.startChartDate.setMinutes(0),this.startChartDate.setSeconds(0);var teams=new Set;teams.add("IL Finance Team"),teams.add("IL Ops Team"),teams.add("Salesforce Team");for(var i=0;myStore.getCount()>i;++i){var el=myStore.getAt(i).data;console.log(i,el);var projectName=el.Project.Name;if(!teams.has(projectName)){var date=el.CreationDate;date.setMilliseconds(0),date.setMinutes(0),date.setSeconds(0),date.setHours(0),map.has(projectName)||map.set(projectName,bufferArrya.slice());var index;index=byMonth?byMonth.get(Ext.Date.format(date,"M Y")):~~((date-this.startChartDate)/1e3/60/60/24/inc+.999),console.log(index),map.get(projectName)[index]++}}var chartData={categories:days,series:[]};this.allArraySum=bufferArrya.slice();for(var colors=[],buff=map.keys(),a=buff.next(),step=0,point=0,numOfStep=map.size,priority=map.size-1;!a.done;){var array=this._sumOfArrayForChart(map.get(a.value)),buffer={name:a.value,data:array,pointPadding:-1,pointPlacement:0,zIndex:priority--};chartData.series.push(buffer),colors.push(this._createColor(numOfStep,step++)),a=buff.next()}console.log(chartData,colors),this.chart=Ext.create("Rally.ui.chart.Chart",{xtype:"rallychart",chartData:chartData,chartConfig:this._getChartConfig(map,indexInDaysArray),chartColors:colors}),this.add(this.chart),this.chart._unmask()},_sumOfArrayForChart:function(arrya){for(var i in arrya)arrya[i]+=this.allArraySum[i],this.allArraySum[i]=arrya[i];return arrya},_getChartConfig:function(map,indexInDaysArray){return{chart:{type:"area"},title:{text:"Escaped Defects Overtime"},xAxis:{labels:{rotation:-45,align:"right",style:{fontSize:"11px",fontFamily:"Verdana, sans-serif"}},tickmarkPlacement:"on",title:{text:"Date"}},yAxis:{min:0,title:{text:"Count"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.01,borderWidth:0,width:.2}}}},_createColor:function rainbow(numOfSteps,step){var r,g,b,h=step/numOfSteps,i=~~(6*h),f=6*h-i,q=1-f;switch(i%6){case 0:r=1,g=f,b=0;break;case 1:r=q,g=1,b=0;break;case 2:r=0,g=1,b=f;break;case 3:r=0,g=q,b=1;break;case 4:r=f,g=0,b=1;break;case 5:r=1,g=0,b=q}var c="#"+("00"+(~~(255*r)).toString(16)).slice(-2)+("00"+(~~(255*g)).toString(16)).slice(-2)+("00"+(~~(255*b)).toString(16)).slice(-2);return c}});

            Rally.launchApp('CustomApp', {
                name:"BasicRallyGrid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
