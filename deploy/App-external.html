<!DOCTYPE html>
<html>
<head>
    <title>BasicRallyGrid</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.myLayout=Ext.create("Ext.container.Container",{layout:{type:"hbox",align:"stretch"}}),this.add(this.myLayout);var filters=[];filters.push(Ext.create("Rally.data.wsapi.Filter",{property:"Environment",operator:"!=",value:"Production"})),filters.push(Ext.create("Rally.data.wsapi.Filter",{property:"Environment",operator:"!=",value:"DR Site"})),filters.push(Ext.create("Rally.data.wsapi.Filter",{property:"c_IssueType",operator:"=",value:"Bug"})),filters.push(Ext.create("Rally.data.wsapi.Filter",{property:"Resolution",operator:"!=",value:"Duplicate"})),filters.push(Ext.create("Rally.data.wsapi.Filter",{property:"Resolution",operator:"!=",value:"Future Enhancement"})),filters.push(Ext.create("Rally.data.wsapi.Filter",{property:"Resolution",operator:"!=",value:"Cannot Replicate"})),this.myFilter=filters[0];for(var i=1;filters.length>i;++i)this.myFilter=this.myFilter.and(filters[i]);var cb=Ext.create("Rally.ui.combobox.FieldValueComboBox",{model:"Defect",field:"Severity",listeners:{ready:function(combobox){var arrayData=cb.getStore();arrayData=arrayData.data.items,this.categoriesForChart=[];for(var i=0;arrayData.length>i;++i){var value=arrayData[i].data.value;this.categoriesForChart.push(value)}this._loadDataForComboBox()},scope:this}});this.add(cb),cb.setVisible(!1)},_loadDataForComboBox:function(){var storeForRelease=Ext.create("Rally.data.wsapi.Store",{model:"Release",filters:[{property:"Name",operator:"Contains",value:"(F)"}],listeners:{load:function(myStore,myData,success){if(!this.releaseStartComboBox){this.arrayOfReleases=[],this.myArray=[];for(var mySet=new Set,day=new Date,i=myStore.getCount()-1;i>-1;--i){var el=myStore.getAt(i).data;if(!mySet.has(el.Name)){this.arrayOfReleases.push(myStore.getAt(i));var string=[];string.push(mySet.size),string.push(el.Name),mySet.add(el.Name),this.myArray.push(string),day>=el.ReleaseStartDate&&el.ReleaseDate>=day&&(this.needSelect=string[0])}}this._loadEndDateForChart(this.myArray)}},scope:this},fetch:["Name","ReleaseStartDate","ReleaseDate","ObjectID","State","PlannedVelocity"],limit:1/0});this.first=!0,storeForRelease.load()},_loadEndDateForChart:function(myStore){this.releaseEndComboBox=Ext.create("Rally.ui.combobox.ComboBox",{fieldLabel:"End Release:",labelAlign:"right",store:myStore,listeners:{ready:function(combobox){this._loadStartDateForChart(myStore)},select:function(combobox,records){this.first||this._loadData()},scope:this},labelWidth:100,width:300}),this.myLayout.add(this.releaseEndComboBox),this._myFunction()},_myFunction:function(){this.releaseEndComboBox.select(this.needSelect),this.releaseStartComboBox.select(this.needSelect),this.first=!1,this._loadData()},_loadStartDateForChart:function(myStore){this.releaseStartComboBox=Ext.create("Rally.ui.combobox.ComboBox",{fieldLabel:"Start Release:",labelAlign:"right",store:myStore,listeners:{ready:function(comobox){},select:function(combobox,records){this.first||this._loadData()},scope:this},labelWidth:100,width:300}),this.myLayout.add(this.releaseStartComboBox)},_loadData:function(){this.chart&&this.remove(this.chart),this.startIndex=this.releaseStartComboBox.getRecord().data.field1,this.endIndex=this.releaseEndComboBox.getRecord().data.field1;var status=Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"!=",value:"Closed"}),releaseFilter;this.releaseById=new Map;for(var size=0,index=this.startIndex;index>=this.endIndex;--index){var openStart=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:">=",value:Ext.Date.format(this.arrayOfReleases[index].data.ReleaseStartDate,"Y-m-d")}),openEnd=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:"<=",value:Ext.Date.format(this.arrayOfReleases[index].data.ReleaseDate,"Y-m-d")}),someFilter=status;someFilter=someFilter.and(openStart).and(openEnd),this.releaseById.set(this.arrayOfReleases[index].data.Name,size++),releaseFilter=releaseFilter?releaseFilter.or(someFilter):someFilter}var needFilter=this.myFilter.and(releaseFilter);console.log("dsdsd",this.arrayOfReleases[0].data),console.log(""+needFilter),this.myStore?(this.myStore.setFilter(needFilter),this.myStore.load()):this.myStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",autoLoad:!0,filters:needFilter,listeners:{load:function(myStore,myData,success){this._createChart(myStore)},scope:this},limit:1/0})},_createChart:function(store){for(var bufferArray=[],releaseNames=[],index=this.startIndex;index>=this.endIndex;--index)bufferArray.push(0),releaseNames.push(this.arrayOfReleases[index].data.Name);this.myMap=new Map;for(var i=0;this.categoriesForChart.length>i;++i)this.myMap.set(this.categoriesForChart[i],bufferArray.slice());for(i=0;store.getCount()>i;++i){var el=store.getAt(i).data;if(el.Requirement){if(console.log(i,el.Requirement),index=0,el.Release)index=this.releaseById.get(el.Release.Name);else if(el.Requirement.Release)index=this.releaseById.get(el.Requirement.Release.Name);else for(var date=el.CreationDate,ind=this.startIndex;ind>=this.endIndex;--ind){var start=this.arrayOfReleases[ind].data.ReleaseStartDate,end=this.arrayOfReleases[ind].data.ReleaseDate;if(date>=start&&end>=date)break;++index}this.myMap.get(el.Severity)[index]++}}for(var chartData={categories:releaseNames,series:[]},buff=this.myMap.keys(),a=buff.next(),colors=[],step=0,numOfStep=this.myMap.size;!a.done;){var buffer={name:a.value,data:this.myMap.get(a.value)};chartData.series.push(buffer),colors.push(this._createColor(numOfStep,step++)),a=buff.next()}this.chart=Ext.create("Rally.ui.chart.Chart",{xtype:"rallychart",chartData:chartData,chartConfig:this._getChartConfig(),chartColors:colors}),this.add(this.chart),this.chart._unmask()},_getChartConfig:function(){return{chart:{type:"column"},title:{text:"Open Defects by Severity Overtime by Sprint/Release (non-production)"},xAxis:{labels:{rotation:-45,align:"right",style:{fontSize:"11px",fontFamily:"Verdana, sans-serif"}},tickmarkPlacement:"on",title:{text:"Date"}},yAxis:{min:0,title:{text:"Count"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{series:{stacking:"normal"}}}},_createColor:function rainbow(numOfSteps,step){var r,g,b,h=step/numOfSteps,i=~~(6*h),f=6*h-i,q=1-f;switch(i%6){case 0:r=1,g=f,b=0;break;case 1:r=q,g=1,b=0;break;case 2:r=0,g=1,b=f;break;case 3:r=0,g=q,b=1;break;case 4:r=f,g=0,b=1;break;case 5:r=1,g=0,b=q}var c="#"+("00"+(~~(255*r)).toString(16)).slice(-2)+("00"+(~~(255*g)).toString(16)).slice(-2)+("00"+(~~(255*b)).toString(16)).slice(-2);return c}});

            Rally.launchApp('CustomApp', {
                name:"BasicRallyGrid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
